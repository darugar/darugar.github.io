<html>
<head>
    <link rel="stylesheet" href="/css/bootstrap/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/css/parand.css">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans|Italianno' rel='stylesheet' type='text/css'>
    <title>Using Django Signals To Watch For Changes To Instances</title>
</head>

<body>

<div class="container">
    <div class="row navigation">
        <div class="span3">
            Parand Tony Darugar
        </div>
        <div class="span8 offset1">
            <span class="nav right"><a href="">About me</a></span>
            <span class="nav right"><a href="http://twitter.com/parand/">@parand</a></span>
            <span class="nav right">s@parand.com</span>
            <!-- span class="nav right"><input type="text" class="input-medium search-query"></span -->
            
        </div>
    </div>

    <div class="row headerrow">
        <div class="span7 heading"><a href="">Using Django Signals To Watch For Changes To Instances</a></div>
        <div class="span5 subheading text-right">A Cruel and Petty Dictator</div>
    </div>

    <!-- CONTENT -->
    <div class="row content">
        <div class="span12">
<p>Say you want to monitor changes to instances of a model and update something based on the changes. In my example I wanted to maintain a sum of the values that had certain characteristics. You can accomplish this with <a href='/web/20101222043406/http://code.djangoproject.com/wiki/Signals'>Django Signals</a>.</p>

<p>Signals are events that fire at various pre-defined moments - for example, before an instance is saved, after it&#8217;s saved, etc. You can subscribe to these events, allowing your callback handler to be called at those moments.</p>

<p>The code below subscribes to the <em>post_init</em> and <em>post_save signals</em>. <em>post_init</em> gets triggered when a model&#8217;s __init__ class is done executing, which generally means when a model instance is created for the first time or instantiated from a query to the DB. This is actually too frequent for the use case I have in mind (checking the before-modification and after-modification values of certain fields), but seems to be the only place I can hook in to get the pre-modification values.</p>

<p><em>post_init</em> gets triggered after the instance is saved to the DB. The code below stores the pre-modification values in <em>pre_save</em> when it gets triggered by the <em>post_init</em> signal, and checks them against the post-modification values when it gets triggered by the <em>post_save</em> signal.</p>

<p>Note that you&#8217;ll probably want to clean up <em>pre_save</em> periodically. Unfortunately <em>post_init</em> and <em>post_save</em> are not symmetrical (you&#8217;ll get a <em>post_init</em> anytime an instance is created, for example when you query the DB), so you can&#8217;t simply delete from <em>pre_save</em> when the <em>post_save</em> signal gets triggered.</p>

<pre><code>from django.dispatch import dispatcher
from django.db.models import signals

pre_save = {}

def change_watcher(sender, instance, signal, *args, **kwargs):
    print &quot;SIGNAL:&quot;, sender, instance.report, signal, args, kwargs
    if signal == signals.post_init:
        pre_save[instance.id] = (instance.field1, instance.field2)
    else:
        if pre_save[instance.id][0] != instance.field1:
            print &quot;Changed field1&quot;
        if pre_save[instance.id][1] != instance.field2:
            print &quot;Changed field2&quot;

for signal in (signals.post_init, signals.post_save):
    dispatcher.connect(change_watcher, sender = Expense, signal = signal)</code></pre>
        </div>
    </div>

    <!-- div class="row contents">
        <div class="span12">
            <img class="img-polaroid" src="http://farm5.staticflickr.com/4148/5066965098_f73170bbf6_b.jpg">
        </div>
    </div>


    <div class="row contents">
        <div class="span12">
<em>What about our student loans?</em> asked one of the students.
        </div>
    </div -->

    <div class="row contents">
        <div class="span12 signature">
            Parand Tony Darugar - 11 Jun 2008
        </div>
    </div>

    <div class="row titlerow">
        <div class="span9 title">More:</div>
    </div>
    <div class="row ">
        <div class="span9 title">&raquo; Martin the Silly Rainbow</div>
        <div class="span3 title-details text-right">January 1st, 2013</div>
    </div>
    <div class="row ">
        <div class="span9 title">&raquo; If I Fell In Love With You</div>
        <div class="span3 title-details text-right">November 16th, 2013</div>
    </div>

</div>

</body>

</html>
